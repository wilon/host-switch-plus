function getIpLocation(ip){var location="";return http_ajax("http://int.dpool.sina.com.cn/iplookup/iplookup.php?format=json&ip="+ip,"GET",!1,function(data){if(!0===data.success)try{var loc=JSON.parse(data.content);void 0!==loc.ret&&(loc.ret<0?location="":1==loc.ret&&(location=loc.country+" "+loc.province+" "+loc.city))}catch(exception){}else location=""}),location}function http_ajax(link,method,aysnc,callback){var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){if(4===xhr.readyState){var respData;respData=200===xhr.status&&xhr.responseText?{success:!0,content:xhr.responseText}:{success:!1,content:"load remote file content failed."},callback(respData)}},xhr.open(method,link,aysnc),xhr.send()}var enableHosts=[];chrome.webRequest.onCompleted.addListener(function(details){setTimeout(function(){details.req="showip",details.hosts=enableHosts,chrome.tabs.sendRequest(details.tabId,details,function(response){})},1e3)},{urls:["http://*/*","https://*/*"],types:["main_frame"]}),chrome.extension.onRequest.addListener(function(request,sender,sendResponse){enableHosts=request}),chrome.runtime.onMessage.addListener(function(request,sender,sendResponse){var location=localStorage[request.ip]||getIpLocation(request.ip);localStorage[request.ip]=location,sendResponse({location:location})});